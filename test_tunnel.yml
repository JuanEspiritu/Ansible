---
# =============================================================================
# PLAYBOOK GATEWAY - Usar vCenter como puente hacia Ubuntu Server
# =============================================================================

- hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ansible_become: false
    vcenter_ip: "168.121.48.254"
    ubuntu_ip: "172.17.25.48"
    
  tasks:
    - name: "ğŸ” Verificar vCenter disponible"
      shell: "curl -k -I https://{{ vcenter_ip }}:10123 --connect-timeout 5"
      register: vcenter_check
      
    - name: "âœ… vCenter OK - Intentar llegar a Ubuntu via vCenter"
      debug:
        msg: "vCenter responde. Configurando tÃºnel SSH..."
      when: "'HTTP' in vcenter_check.stdout"
      
    - name: "ğŸš€ Crear tÃºnel SSH via vCenter"
      shell: |
        # Intentar conexiÃ³n SSH directa desde vCenter a Ubuntu
        ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -W {{ ubuntu_ip }}:22 root@{{ vcenter_ip }}" \
            ubuntu@{{ ubuntu_ip }} 'echo "ConexiÃ³n exitosa via vCenter"'
      register: tunnel_result
      ignore_errors: yes
      
    - name: "ğŸ“Š Resultado del tÃºnel"
      debug:
        msg: |
          {% if tunnel_result.rc == 0 %}
          âœ… Â¡TÃºnel SSH funciona! Ansible puede usar vCenter como gateway.
          ğŸš€ Configurar ansible.cfg con ProxyCommand
          {% else %}
          âŒ TÃºnel SSH no funciona. Error: {{ tunnel_result.stderr }}
          ğŸ’¡ Necesitamos habilitar SSH en vCenter o usar otra estrategia
          {% endif %}